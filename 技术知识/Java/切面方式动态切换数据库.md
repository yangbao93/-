# 切面方式动态切换数据库
1. 设置扫描的注解

> /**  
> * 多数据源切换时定义的注解  
> * Created by Administrator on 2017/9/27.  
> */  
> @Retention(RetentionPolicy.RUNTIME)  
> @Target(ElementType.METHOD)  
> public @interface DataSource {  
> DataSourceEnum value();  
> }  

1. 设置DataSourceEnum 这里主要是靠这个的值判断使用哪个数据库

> public enum DataSourceEnum {  
> MAIN("mainData"), AUTH( "authData"), CLIENT("clientData");  
> private String value;  

> private DataSourceEnum( String value) {  
> this.value = value;  
> }  

> public String getValue() {  
> return value;  
> }  

> public void setValue(String value) {  
> this.value = value;  
> }  
> }  

1. 设置DataSourceHolder 的切换

> public class DataSourceHolder {  
> public static final ThreadLocal<String> holder = new ThreadLocal<String>();  
> public static void putDataSource(String datasource) {  
> holder.set(datasource);  
> }  

> public static String getDataSource() {  
> return holder.get();  
> }  

> public static void clearDataSource(){  
> holder.remove();  
> }  
> }  

1. 设置DBRoutingDataSource
	1. extends AbstractRoutingDataSource

> /**  
> * 实现aop数据源切换  
> * Created by Administrator on 2017/9/27.  
> */  
> public class DBRoutingDataSource extends AbstractRoutingDataSource {  
> @Override  
> protected Object determineCurrentLookupKey() {  
> return DataSourceHolder.getDataSource();  
> }  

> @Override  
> public void setTargetDataSources(Map targetDataSources) {  
> super.setTargetDataSources(targetDataSources);  
> }  

> @Override  
> public Object unwrap(Class iface) throws SQLException {  
> return null;  
> }  

> @Override  
> public boolean isWrapperFor(Class iface) throws SQLException {  
> return false;  
> }  
> }  

1. 设置切面进入后的操作

>   
> /**  
> * 切面  
> * Created by Administrator on 2017/9/27.  
> */  
> @Aspect  
> public class DetermineAspect {  

> // @Pointcut("within(com.yonyou.einvoice.oprtdata.service.impl.*)")  
> public void pointCut() {}  

> // @Before("pointCut()")  
> public void before(JoinPoint point) {  
> Object target = point.getTarget();  
> System.out.println(target.toString());  
> String method = point.getSignature().getName();  
> System.out.println(method);  
> Class<?> classz = target.getClass();  
> Class<?>[] parameterTypes =  
> ((MethodSignature) point.getSignature()).getMethod().getParameterTypes();  
> try {  
> Method m = classz.getMethod(method, parameterTypes);  
> System.out.println(m.getName());  
> if (m != null && m.isAnnotationPresent(DataSource.class)) {  
> DataSource data = m.getAnnotation(DataSource.class);  
> DataSourceHolder.putDataSource(data.value().getValue());  
> }  

> } catch (Exception e) {  
> e.printStackTrace();  
> }  

> }  
> }  

1. 设置数据库配置文件

```
<?xml version="1.0" encoding="UTF-8"?>
```

<beans xmlns="[http://www.springframework.org/schema/beans"](http://www.springframework.org/schema/beans%22);
xmlns:xsi="[http://www.w3.org/2001/XMLSchema-instance"](http://www.w3.org/2001/XMLSchema-instance%22);
xmlns:p="[http://www.springframework.org/schema/p"](http://www.springframework.org/schema/p%22);
xmlns:context="[http://www.springframework.org/schema/context"](http://www.springframework.org/schema/context%22);
xmlns:aop="[http://www.springframework.org/schema/aop"](http://www.springframework.org/schema/aop%22);
xmlns:tx="[http://www.springframework.org/schema/tx"](http://www.springframework.org/schema/tx%22);
xmlns:util="[http://www.springframework.org/schema/util"](http://www.springframework.org/schema/util%22);
xsi:schemaLocation="[http://www.springframework.org/schema/beans](http://www.springframework.org/schema/beans)
[http://www.springframework.org/schema/beans/spring-beans-3.2.xsd](http://www.springframework.org/schema/beans/spring-beans-3.2.xsd)
[http://www.springframework.org/schema/context](http://www.springframework.org/schema/context)
[http://www.springframework.org/schema/context/spring-context-3.2.xsd](http://www.springframework.org/schema/context/spring-context-3.2.xsd)
[http://www.springframework.org/schema/tx](http://www.springframework.org/schema/tx)
[http://www.springframework.org/schema/tx/spring-tx-3.2.xsd](http://www.springframework.org/schema/tx/spring-tx-3.2.xsd)
[http://www.springframework.org/schema/aop](http://www.springframework.org/schema/aop)
[http://www.springframework.org/schema/aop/spring-aop-3.2.xsd](http://www.springframework.org/schema/aop/spring-aop-3.2.xsd)
[http://www.springframework.org/schema/util](http://www.springframework.org/schema/util)
[http://www.springframework.org/schema/util/spring-util-3.2.xsd"](http://www.springframework.org/schema/util/spring-util-3.2.xsd%22);>

<bean id="dataSource1" class="com.alibaba.druid.pool.DruidDataSource"
init-method="init" destroy-method="close">
<!-- connection info -->
<property name="driverClassName">
<value>${jdbc.driver}</value>
</property>
<property name="url">
<value>${jdbc.url}</value>
</property>
<property name="username">
<value>${jdbc.username}</value>
</property>
<property name="password">
<value>${jdbc.password}</value>
</property>

<!-- 连接池最大使用连接数 -->
<property name="maxActive">
<value>${jdbc.pool.maxActive}</value>
</property>
<!-- 初始化连接大小 -->
<property name="initialSize">
<value>${jdbc.pool.init}</value>
</property>
<!-- 获取连接最大等待时间 -->
<property name="maxWait">
<value>${jdbc.pool.maxWait}</value>
</property>
<!-- 连接池最小空闲 -->
<property name="minIdle">
<value>${jdbc.pool.minIdle}</value>
</property>
<property name="timeBetweenEvictionRunsMillis" value="60000"/>
<!-- 连接保持空闲而不被驱逐的最长时间 -->
<property name="minEvictableIdleTimeMillis" value="300000"/>

<property name="testWhileIdle" value="true"/>
<property name="testOnBorrow" value="false"/>
<property name="testOnReturn" value="false"/>

<!-- 用来检测连接是否有效的sq -->
<property name="validationQuery" value="select 'x'"/>
<!-- 检测连接是否有效的超时时间 -->
<!-- <property name="validationQueryTimeout" value="10" /> -->

<!-- 超过时间限制是否回收 -->
<property name="removeAbandoned" value="true"/>
<!-- 超时时间；单位为秒。180秒=3分钟 -->
<property name="removeAbandonedTimeout" value="600"/>
<!-- 关闭abanded连接时输出错误日志 -->
<property name="logAbandoned" value="true"/>
<!-- 连接属性 -->
<property name="connectionProperties">
<value>clientEncoding=UTF-8</value>
</property>
</bean>

<!-- 配置数据库别名 -->
<!--<util:properties id="myPropertyConfigurer" location="classpath:dbname.properties" />-->

<bean id="datasource2" class="com.alibaba.druid.pool.DruidDataSource" destroy-method="close">
<property name="driverClassName">
<value>${database.driverClass}</value>
</property>
<property name="url">
<value>${database.url2}
</value>
</property>
<property name="username">
<value>${database.user2}</value>
</property>
<property name="password">
<value>${database.password2}</value>
</property>
</bean>

<bean id="datasource3" class="com.alibaba.druid.pool.DruidDataSource" destroy-method="close">
<property name="driverClassName">
<value>${database.driverClass}</value>
</property>
<property name="url">
<value>${database.url3}</value>
</property>
<property name="username">
<value>${database.user3}</value>
</property>
<property name="password">
<value>${database.password3}</value>
</property>
</bean>

<!-- mybatis文件配置，扫描所有mapper文件 -->
<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean"
p:dataSource-ref="dataSource">
<property name="mapperLocations">
<list>
<!--<value>classpath*:com/yonyou/einvoice/oprtdata/mapper/*.xml</value>-->
<value>classpath*:/mapper/*.xml</value>
</list>
</property>
<!--<property name="configurationProperties" ref="myPropertyConfigurer"></property>-->
</bean>
<bean id="dataSource" class="com.yonyou.einvoice.oprtdata.util.DBRoutingDataSource">
<property name="targetDataSources">
<map key-type="java.lang.String">
<!-- write -->
<entry key="mianData" value-ref="dataSource1"/>
<!-- read -->
<entry key="authData" value-ref="datasource2"/>
<entry key="clientData" value-ref="datasource3"/>
</map>

</property>
<property name="defaultTargetDataSource" ref="dataSource1"/>
</bean>
<!-- spring与mybatis整合配置，扫描所有dao -->
<bean class="org.mybatis.spring.mapper.MapperScannerConfigurer"
p:basePackage="com.yonyou.einvoice.oprtdata.repoistory"

p:sqlSessionFactoryBeanName="sqlSessionFactory"/>

<!-- 对数据源进行事务管理 -->
<bean id="transactionManagerMybatis"
class="org.springframework.jdbc.datasource.DataSourceTransactionManager"
p:dataSource-ref="dataSource"/>

<!-- 配置数据库注解aop -->
<bean id="dataSourceAspect" class="com.yonyou.einvoice.oprtdata.util.DetermineAspect"/>
<aop:config>
<aop:aspect id="c" ref="dataSourceAspect">
<aop:pointcut id="tx"
expression="execution(* com.yonyou.einvoice.oprtdata.service..*.*(..))"/>
<aop:before pointcut-ref="tx" method="before"/>
</aop:aspect>
</aop:config>
</beans>

1. 设置注解扫描

1. 切面调用

>   
> @DataSource(DataSourceEnum.AUTH)  
> @Override  
> public List<StatisticsUser> getActiveCorpInfo(List<String> corpIdList) {  
> // 根据corpId查询信息  
> List<StatisticsUser> corpList = userRepo.getActiveCorpInfo(corpIdList);  
> // 设置登录时间  
> this.buildLoginTime(corpList);  

> return corpList;  
> }  

* 参考 [https://hacpai.com/article/1488101038281](https://hacpai.com/article/1488101038281)

about:blank